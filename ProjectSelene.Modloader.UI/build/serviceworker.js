var u=class{constructor(){this.nextId=1,this.messageQueue=new Map,self.onmessage=()=>{},self.addEventListener("message",e=>{e.origin===location.origin&&this.handleCallback(e.data)})}handleCallback(e){let t=this.messageQueue.get(e.id);t&&e.success!==void 0&&(t.count--,t.results.push(e.data),e.success||(t.success=!1),t.count<=0&&(e.success?t.resolve(t.results):t.reject(t.results),this.messageQueue.delete(e.id)))}on(e,t){self.addEventListener("message",r=>{var a,n,i;if(r.origin!==location.origin)return;if(!(r.source instanceof Client)){(a=r.source)===null||a===void 0||a.postMessage({id:(n=r.data)===null||n===void 0?void 0:n.id,success:!1,data:{sourceId:(i=r?.source)===null||i===void 0?void 0:i.id,message:"Can only process messages from clients"}});return}let o=r.data;o.type===e&&r.waitUntil(Promise.resolve().then(()=>t(o.data,r.source instanceof Client?r.source.id+"":"")).then(l=>{var c;return(c=r.source)===null||c===void 0?void 0:c.postMessage({id:o.id,success:!0,data:l})}).catch(l=>{var c;return(c=r.source)===null||c===void 0?void 0:c.postMessage({id:o.id,success:!1,data:l})}))})}sendToClients(e,t,r,a=300){let n=this.nextId++,i=new Set(r);return Promise.race([self.clients.matchAll({type:"window"}).then(o=>(o=o.filter(l=>i.has(l.id)),o.length===0?[]:this.internalSendToClients(n,o,e,t))),this.deleteAfterDelay(n,a)])}internalSendToClients(e,t,r,a){return new Promise((n,i)=>{this.messageQueue.set(e,{count:t.length,results:[],success:!0,resolve:n,reject:i});for(let o of t)o.postMessage({id:e,data:a,type:r})})}deleteAfterDelay(e,t){return new Promise((r,a)=>{setTimeout(()=>{this.messageQueue.delete(e),console.error(`Failed to receive response after ${t} ms`),a(new Error("Timeout"))},t)})}};var d=class{constructor(e){this.messagePort=e,this.resolveQueue=new Map,this.rejectQueue=new Map,this.messagePort.onmessage=()=>{},this.messagePort.addEventListener("message",t=>{var r,a;let n=t.data;n.success?(r=this.resolveQueue.get(n.id))===null||r===void 0||r(n.data):(a=this.rejectQueue.get(n.id))===null||a===void 0||a(n.data),this.resolveQueue.delete(n.id),this.rejectQueue.delete(n.id)})}send(e,t,...r){return new Promise((a,n)=>{let i=Math.random()*1e6+Math.random();this.resolveQueue.set(i,a),this.rejectQueue.set(i,n),this.messagePort.postMessage({id:i,data:t,type:e},r.filter(o=>o))})}on(e,t){this.messagePort.addEventListener("message",r=>{let a=r.data;a.type===e&&Promise.resolve().then(()=>t(a.data)).then(n=>this.messagePort.postMessage({id:a.id,success:!0,data:n})).catch(n=>this.messagePort.postMessage({id:a.id,success:!1,data:n}))})}};function m(s){return new Promise((e,t)=>{s.oncomplete=s.onsuccess=()=>e(s.result),s.onabort=s.onerror=()=>t(s.error)})}function p(s,e){let t,r=()=>{if(t)return t;let a=indexedDB.open(s);return a.onupgradeneeded=()=>a.result.createObjectStore(e),t=m(a),t.then(n=>{n.onclose=()=>t=void 0},()=>{}),t};return(a,n)=>r().then(i=>n(i.transaction(e,a).objectStore(e)))}var f;function v(){return f||(f=p("keyval-store","keyval")),f}function b(s,e=v()){return e("readonly",t=>m(t.get(s)))}function w(s,e,t=v()){return t("readwrite",r=>(r.put(e,s),m(r.transaction)))}var g=p("SeleneDb-sw-cache","sw-cache"),h=class{constructor(){this.clients=[]}async load(){var e;this.clients=(e=await b("clients",g))!==null&&e!==void 0?e:[],await this.removeInactiveClients()}async removeInactiveClients(){let e=(await self.clients.matchAll({type:"window"})).filter(t=>this.clients.includes(t.id)).map(t=>t.id).sort();await w("clients",e,g),this.clients=e}getClients(){return this.clients}async addClient(e){this.clients.push(e),this.clients.sort(),await w("clients",this.clients,g)}};var k=new Map,y=new h,P=new u;P.on("workers",async(s,e)=>{k.set(e,{lastWorker:0,workers:s.map(t=>new d(t))}),await y.addClient(e)});self.addEventListener("install",s=>("addRoutes"in s&&s.addRoutes([{condition:{urlPattern:"http://localhost:8182/*"},source:"network"},{condition:{urlPattern:"http://127.0.0.1:8182/*"},source:"network"},{condition:{urlPattern:self.origin+"/api/*"},source:"race-network-and-fetch-handler"}]),self.skipWaiting(),s.waitUntil(caches.open("selene-loader").then(e=>e.add("static/js/prefix.js")).catch(()=>{}))));async function A(){await y.load(),await P.sendToClients("install",{},y.getClients(),300)}var Q=A().catch(s=>console.error(s));self.addEventListener("activate",()=>self.clients.claim());self.addEventListener("fetch",s=>s.respondWith(Q.then(()=>{if(s.request.headers.get("Accept")==="text/event-stream")return fetch(s.request);let e=k.get(s.clientId);return e?T(s,e):x(s.request)})));async function T(s,e){var t;let r=(((t=e.lastWorker)!==null&&t!==void 0?t:0)+1)%e.workers.length,a=e.workers[r];e.lastWorker=r;let n=new TransformStream,i=s.request.body;if((s.request.method==="POST"||s.request.method==="PUT")&&!i){let l=new TransformStream;i=l.readable;let c=l.writable.getWriter();s.request.arrayBuffer().then(C=>{c.write(new Uint8Array(C)),c.close()}).catch(()=>c.abort())}let o=a.send("fetch",{request:{method:s.request.method,url:s.request.url,headers:E(s.request.headers),body:i,clientId:s.clientId},response:n.writable},n.writable,i);return new Response(n.readable,await o)}async function x(s){if(s.url.startsWith("chrome-extension")||s.method!=="GET")return fetch(s);if(!navigator.onLine){let e=await caches.match(s);if(e)return e}try{let e=await fetch(s);return await(await caches.open("selene-loader")).put(s,e.clone()),e}catch{let t=await caches.match(s);return t||new Response("Network error happened",{status:408,headers:{"Content-Type":"text/plain"}})}}function E(s){let e={};return s.forEach((t,r)=>e[r]=t),e}
//# sourceMappingURL=serviceworker.js.map
